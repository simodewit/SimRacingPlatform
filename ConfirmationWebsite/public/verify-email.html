<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Email verification | SimRacingPlatform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #e5e7eb; /* gray background */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px 28px;
        max-width: 420px;
        width: 100%;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.12);
        text-align: center;
      }

      h1 {
        margin: 0 0 12px;
        font-size: 1.4rem;
      }

      p {
        margin: 0 0 16px;
        color: #4b5563;
      }

      .status {
        font-size: 0.95rem;
        margin-bottom: 20px;
      }

      .status.loading {
        color: #6b7280;
      }

      .status.success {
        color: #16a34a;
      }

      .status.error {
        color: #dc2626;
      }

      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        background: #111827;
        color: #ffffff;
        transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
          background 0.15s ease-out, opacity 0.15s ease-out;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.3);
      }

      .button:hover {
        transform: translateY(-1px);
        box-shadow: 0 15px 30px rgba(15, 23, 42, 0.35);
        background: #020617;
      }

      .button:active {
        transform: translateY(0);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
      }

      .button:disabled {
        opacity: 0.6;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .hint {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Email verification</h1>
      <p class="status loading" id="status">
        Verifying your email, please wait…
      </p>

      <button class="button" id="open-app-btn" disabled>
        Open SimRacingPlatform
      </button>

      <p class="hint" id="hint">
        We’ll enable the button once your email is confirmed.
      </p>
    </div>

    <script type="module">
      // 1. Firebase imports (modular SDK)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import {
        getAuth,
        applyActionCode,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

      // 2. TODO: Put YOUR Firebase config here
      //    (same project as the one sending the email verification links)
      const firebaseConfig = {
        apiKey: "AIzaSyAQoyg7y5OmivRsyOyy2eT7qUfFT16VI_M",
        authDomain: "simracingplatform-1370c.firebaseapp.com",
        projectId: "simracingplatform-1370c",
        // etc. (copy from Firebase console → Project settings → General)
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const statusEl = document.getElementById("status");
      const buttonEl = document.getElementById("open-app-btn");
      const hintEl = document.getElementById("hint");

      buttonEl.addEventListener("click", () => {
        // Custom URI that your WinUI3 app handles
        window.location.href = "simracingplatform://verified";
      });

      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function handleEmailVerification() {
        const mode = getQueryParam("mode");
        const oobCode = getQueryParam("oobCode");

        if (mode !== "verifyEmail" || !oobCode) {
          statusEl.textContent = "Invalid or malformed verification link.";
          statusEl.className = "status error";
          hintEl.textContent =
            "Please open the link from your latest verification email.";
          return;
        }

        try {
          await applyActionCode(auth, oobCode);

          // ✅ Success
          statusEl.textContent = "Your email has been successfully verified.";
          statusEl.className = "status success";
          hintEl.textContent =
            "You can now return to the SimRacingPlatform app.";
          buttonEl.disabled = false;

          // Optional: also auto-redirect after a short delay:
          // setTimeout(() => {
          //   window.location.href = "simracingplatform://verified";
          // }, 1500);
        } catch (error) {
          console.error(error);
          statusEl.textContent =
            "This verification link is invalid or has expired.";
          statusEl.className = "status error";
          hintEl.textContent =
            "Request a new verification email from inside the app.";
          buttonEl.disabled = true;
        }
      }

      handleEmailVerification();
    </script>
  </body>
</html>
